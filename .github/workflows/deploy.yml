name: Deploy Astro to REG.RU via SSH

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üöö Checkout code
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: üì¶ Install dependencies
      run: npm ci
    
    - name: üî® Build project
      run: npm run build
    
    - name: üìÅ Check build files
      run: |
        echo "Files in dist/:"
        ls -la dist/
        echo "Checking for index.html..."
        if [ ! -f "dist/index.html" ]; then
          echo "‚ùå ERROR: No index.html in dist/"
          exit 1
        fi
        echo "‚úÖ Build looks good"
    
    - name: üöÄ Deploy via SSH (rsync)
      env:
        SSH_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      run: |
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ sshpass –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–æ–ª–µ–º
        sudo apt-get update && sudo apt-get install -y sshpass
        
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ rsync (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
        echo "Starting rsync deployment..."
        sshpass -p "$SSH_PASSWORD" rsync -avz \
          --delete \
          --progress \
          -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
          ./dist/ \
          u3339934@31.31.197.15:/www/rus-news.online/
        
        echo "‚úÖ Files uploaded successfully"
    
    - name: üéâ Verify deployment
      env:
        SSH_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      run: |
        echo "Checking files on server..."
        sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
          u3339934@31.31.197.15 \
          "ls -la /www/rus-news.online/ && echo 'Deployment verified!'"