name: Deploy Astro to REG.RU via SSH

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üöö Checkout code
      uses: actions/checkout@v4
    
    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: üì¶ Install dependencies
      run: npm ci
    
    - name: üî® Build project
      run: npm run build
    
    - name: üìÅ Check build files
      run: |
        echo "Files in dist/:"
        ls -la dist/
        if [ -f "dist/index.html" ]; then
          echo "‚úÖ Build successful - index.html found"
        else
          echo "‚ùå ERROR: No index.html in dist/"
          exit 1
        fi
    
    - name: üöÄ Deploy via SSH
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      run: |
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ sshpass (—É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        sudo apt-get update && sudo apt-get install -y sshpass
        
        # –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        echo "Testing SSH connection..."
        sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
          $SSH_USERNAME@$SSH_HOST "echo 'SSH connection successful'"
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ rsync
        echo "Uploading files via rsync..."
        sshpass -p "$SSH_PASSWORD" rsync -avz \
          --delete \
          --progress \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./dist/ \
          $SSH_USERNAME@$SSH_HOST:/www/rus-news.online/
        
        echo "‚úÖ Deployment completed!"
    
    - name: üéâ Verify deployment
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      run: |
        echo "Checking files on server..."
        sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
          $SSH_USERNAME@$SSH_HOST \
          "ls -la /www/rus-news.online/ | head -20 && echo '--- Deployment verified! ---'"