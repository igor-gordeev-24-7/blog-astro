---
import Layout from '../../layouts/Layout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { 
  getArticlesByCategorySimple, 
  getArticles, 
  categoryToSlug,
  slugToCategory,
  getPredefinedCategories,
  isPredefinedCategory 
} from '../../utils/articles-simple';

export async function getStaticPaths() {
  const articles = await getArticles();
  const predefinedCategories = getPredefinedCategories();
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ —Å—Ç–∞—Ç–µ–π
  const articleCategories = [...new Set(articles.map(a => a.frontmatter.category).filter(Boolean))];
  
  // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ —Å—Ç–∞—Ç–µ–π –∏ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const allCategories = [...new Set([...articleCategories, ...predefinedCategories])];
  
  return allCategories.map((category) => ({
    params: {
      category: categoryToSlug(category),
    },
  }));
}

const { category = '' } = Astro.params;

// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º slug –æ–±—Ä–∞—Ç–Ω–æ –≤ —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
const categoryName = slugToCategory(category);
const articles = await getArticlesByCategorySimple(category);
const allArticles = await getArticles();
const allCategories = [...new Set(allArticles.map(a => a.frontmatter.category).filter(Boolean))];
const predefinedCategories = getPredefinedCategories();

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π
const isPredefined = isPredefinedCategory(category);

// –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—É—Å—Ç–∞—è –ò–õ–ò —ç—Ç–æ –Ω–µ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ò –Ω–µ—Ç —Å—Ç–∞—Ç–µ–π, —Ç–æ–≥–¥–∞ 404
if (!category || (!isPredefined && articles.length === 0)) {
  console.log(`Redirecting to 404: category="${category}", isPredefined=${isPredefined}, articles=${articles.length}`);
  return Astro.redirect('/404');
}

console.log(`Category: ${categoryName}, Articles: ${articles.length}, Is predefined: ${isPredefined}`);
---

<Layout 
  title={`${categoryName} - –ù–æ–≤–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ç—å–∏ | –ú–æ–π –±–ª–æ–≥`}
  description={`–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ç—å–∏ –Ω–∞ —Ç–µ–º—É ${categoryName}. –í—Å–µ —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –≤ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.`}
>
  <div class="container">
    <div class="category-header">
      <h1 class="category-title">{categoryName}</h1>
      <p class="category-description">
        –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ —Å—Ç–∞—Ç—å–∏ –Ω–∞ —Ç–µ–º—É {categoryName}. –í—Å–µ —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –≤ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
      </p>
      <div class="category-count">
        <span class="count-number">{articles.length}</span> {articles.length === 1 ? '—Å—Ç–∞—Ç—å—è' : articles.length < 5 ? '—Å—Ç–∞—Ç—å–∏' : '—Å—Ç–∞—Ç–µ–π'}
      </div>
    </div>

    {articles.length > 0 ? (
      <div class="category-articles">
        <div class="articles-grid">
          {articles.map((article) => (
            <ArticleCard article={article} />
          ))}
        </div>
      </div>
    ) : (
      <div class="no-articles">
        <div class="no-articles-content">
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <h2>–ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–µ–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{categoryName}"</h2>
            <p>–≠—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –µ—â–µ –ø—É—Å—Ç–∞, –Ω–æ –º—ã –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –Ω–æ–≤—ã–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏. –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Å—Ç–∞—Ç—å–∏!</p>
            
            <div class="suggestions">
              <h3>–ê –ø–æ–∫–∞ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ:</h3>
              <div class="suggestion-cards">
                <a href="/" class="suggestion-card">
                  <span class="suggestion-icon">üè†</span>
                  <div class="suggestion-content">
                    <h4>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h4>
                    <p>–í—Å–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</p>
                  </div>
                </a>
                
                <a href="/about" class="suggestion-card">
                  <span class="suggestion-icon">‚ÑπÔ∏è</span>
                  <div class="suggestion-content">
                    <h4>–û —Å–∞–π—Ç–µ</h4>
                    <p>–£–∑–Ω–∞–π—Ç–µ –±–æ–ª—å—à–µ –æ –Ω–∞—à–µ–º –±–ª–æ–≥–µ</p>
                  </div>
                </a>
              </div>
            </div>
          </div>
          
          <div class="other-categories-section">
            <h3>–î—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Å—Ç–∞—Ç—å—è–º–∏:</h3>
            <div class="other-categories">
              {allCategories.filter(cat => {
                const catSlug = categoryToSlug(cat);
                return catSlug !== category;
              }).map(cat => {
                const catSlug = categoryToSlug(cat);
                return (
                  <a href={`/category/${catSlug}`} class="category-link">
                    {cat}
                  </a>
                );
              })}
            </div>
          </div>
        </div>
      </div>
    )}

    <aside class="all-categories">
      <h2>–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
      <div class="categories-list">
        {[...new Set([...allCategories, ...predefinedCategories])].map(cat => {
          const catSlug = categoryToSlug(cat);
          const isActive = catSlug === category;
          const hasArticles = allCategories.includes(cat);
          
          // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          const articlesInCategory = allArticles.filter(
            article => article.frontmatter.category === cat
          ).length;
          
          return (
            <a 
              href={`/category/${catSlug}`} 
              class={`category-item ${isActive ? 'active' : ''} ${!hasArticles ? 'empty-category' : ''}`}
              title={!hasArticles ? '–ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–µ–π' : `${articlesInCategory} ${articlesInCategory === 1 ? '—Å—Ç–∞—Ç—å—è' : articlesInCategory < 5 ? '—Å—Ç–∞—Ç—å–∏' : '—Å—Ç–∞—Ç–µ–π'}`}
            >
              <span class="category-icon">
                {cat === '–ü–æ–ª–∏—Ç–∏–∫–∞' && 'üì∞'}
                {cat === '–í –º–∏—Ä–µ' && 'üåç'}
                {cat === '–≠–∫–æ–Ω–æ–º–∏–∫–∞' && 'üí∞'}
                {cat === '–û–±—â–µ—Å—Ç–≤–æ' && 'üë•'}
                {cat === '–ü—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è' && 'üö®'}
                {cat === '–ö—É–ª—å—Ç—É—Ä–∞' && 'üé®'}
                {cat === '–¢—É—Ä–∏–∑–º' && '‚úàÔ∏è'}
                {cat === '–ù–∞—É–∫–∞' && 'üî¨'}
                {cat === '–°–ø–æ—Ä—Ç' && '‚öΩ'}
                {!['–ü–æ–ª–∏—Ç–∏–∫–∞', '–í –º–∏—Ä–µ', '–≠–∫–æ–Ω–æ–º–∏–∫–∞', '–û–±—â–µ—Å—Ç–≤–æ', '–ü—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è', 
                   '–ö—É–ª—å—Ç—É—Ä–∞', '–¢—É—Ä–∏–∑–º', '–ù–∞—É–∫–∞', '–°–ø–æ—Ä—Ç'].includes(cat) && 'üìÑ'}
              </span>
              <span class="category-text">{cat}</span>
              <span class="category-count-badge">
                {articlesInCategory > 0 ? articlesInCategory : ''}
              </span>
              {!hasArticles && <span class="empty-badge">–ø—É—Å—Ç–æ</span>}
            </a>
          );
        })}
      </div>
    </aside>
  </div>
</Layout>

<style>
.category-header {
  text-align: center;
  padding: 3rem 1rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 12px;
  margin-bottom: 3rem;
}

.category-title {
  font-size: 2.5rem;
  margin: 0 0 1rem 0;
}

.category-description {
  font-size: 1.1rem;
  opacity: 0.9;
  max-width: 600px;
  margin: 0 auto 1.5rem;
}

.category-count {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: rgba(255, 255, 255, 0.2);
  padding: 0.5rem 1.5rem;
  border-radius: 20px;
  font-size: 0.9rem;
}

.count-number {
  font-weight: bold;
  font-size: 1.2rem;
}

.articles-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 2rem;
  margin: 2rem 0;
}

.no-articles {
  padding: 4rem 2rem;
  background: #f8f9fa;
  border-radius: 12px;
  margin: 2rem 0;
  border: 2px dashed #ddd;
}

.empty-state {
  text-align: center;
  max-width: 800px;
  margin: 0 auto;
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 1.5rem;
  opacity: 0.5;
}

.empty-state h2 {
  color: #555;
  margin-bottom: 1rem;
  font-size: 1.8rem;
}

.empty-state p {
  color: #777;
  font-size: 1.1rem;
  line-height: 1.6;
  margin-bottom: 2rem;
}

.suggestions {
  margin: 3rem 0;
  padding-top: 2rem;
  border-top: 1px solid #eee;
}

.suggestions h3 {
  color: #555;
  margin-bottom: 1.5rem;
  font-size: 1.3rem;
}

.suggestion-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  max-width: 600px;
  margin: 0 auto;
}

.suggestion-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  background: white;
  border-radius: 12px;
  text-decoration: none;
  color: #333;
  border: 1px solid #e9ecef;
  transition: all 0.3s;
}

.suggestion-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  border-color: #667eea;
}

.suggestion-icon {
  font-size: 2rem;
  flex-shrink: 0;
}

.suggestion-content h4 {
  margin: 0 0 0.5rem 0;
  font-size: 1.1rem;
  color: #333;
}

.suggestion-content p {
  margin: 0;
  color: #666;
  font-size: 0.9rem;
}

.other-categories-section {
  margin-top: 3rem;
  padding-top: 2rem;
  border-top: 1px solid #eee;
}

.other-categories-section h3 {
  color: #555;
  margin-bottom: 1.5rem;
  text-align: center;
  font-size: 1.3rem;
}

.other-categories {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
  max-width: 800px;
  margin: 0 auto;
}

.category-link {
  background: #667eea;
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  text-decoration: none;
  font-size: 0.9rem;
  transition: all 0.3s;
}

.category-link:hover {
  background: #5a67d8;
  transform: translateY(-2px);
}

.all-categories {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 2px 20px rgba(0,0,0,0.1);
  margin: 3rem 0;
}

.all-categories h2 {
  margin: 0 0 1.5rem 0;
  color: #333;
}

.categories-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
}

.category-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 8px;
  text-decoration: none;
  color: #555;
  transition: all 0.3s;
  position: relative;
  justify-content: space-between;
}

.category-item:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}

.category-item.active {
  background: #667eea;
  color: white;
}

.category-item.empty-category {
  opacity: 0.7;
    color: #555;
  background: #f0f0f0;
}

.category-item.empty-category.active {
    color: #555;
}

.category-icon {
  font-size: 1.2rem;
}

.category-text {
  font-weight: 500;
  flex: 1;
}

.category-count-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  height: 24px;
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: bold;
  margin-left: 0.5rem;
  padding: 0 0.5rem;
}

.category-item.active .category-count-badge {
  background: rgba(255, 255, 255, 0.3);
  color: white;
}

.category-item.empty-category .category-count-badge {
  display: none;
}

.empty-badge {
  background: rgba(0,0,0,0.1);
  color: #666;
  padding: 0.2rem 0.5rem;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: normal;
}

.category-item.active .empty-badge {
  background: rgba(255,255,255,0.3);
  color: white;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
  .category-title {
    font-size: 2rem;
  }
  
  .articles-grid {
    grid-template-columns: 1fr;
  }
  
  .categories-list {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  }
  
  .suggestion-cards {
    grid-template-columns: 1fr;
  }
  
  .empty-icon {
    font-size: 3rem;
  }
  
  .empty-state h2 {
    font-size: 1.5rem;
  }
  
  .category-item {
    padding: 0.75rem;
    gap: 0.5rem;
  }
  
  .category-count-badge {
    min-width: 20px;
    height: 20px;
    font-size: 0.7rem;
    margin-left: 0.25rem;
  }
}
</style>